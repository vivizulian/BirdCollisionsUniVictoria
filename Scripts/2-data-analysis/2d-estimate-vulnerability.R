
#######################
## Extract estimates from abundance
## Estimate species-specific vulnerability

#######################


# set dirs ----------------------------------------------------------------

run_date <- Sys.Date()
data_run_date <- 'XXX'
data_run_date_fall <- 'XXX'
dir <- 'XXX'



# load packages -----------------------------------------------------------

library(dplyr)



# read in data -----------------------------------------------------------

#fall 2019
fall2019_output <- readRDS(paste0(dir, 'Results/Fall2019-output-', data_run_date_fall, '/Fall2019-output-', data_run_date_fall, '.rds'))
fall2019_data <- readRDS(paste0(dir, 'Results/Fall2019-output-', data_run_date_fall, '/Fall2019-data-', data_run_date_fall, '.rds'))


#fall 2020
fall2020_output <- readRDS(paste0(dir, 'Results/Fall2020-output-', data_run_date_fall, '/Fall2020-output-', data_run_date_fall, '.rds'))
fall2020_data <- readRDS(paste0(dir, 'Results/Fall2020-output-', data_run_date_fall, '/Fall2020-data-', data_run_date_fall, '.rds'))


#late winter 2020
lateWinter2020_output <- readRDS(paste0(dir, 'Results/LateWinter2020-output-', data_run_date, '/LateWinter2020-output-', data_run_date, '.rds'))
lateWinter2020_data <- readRDS(paste0(dir, 'Results/LateWinter2020-output-', data_run_date, '/LateWinter2020-data-', data_run_date, '.rds'))


#early winter 2021
earlyWinter2021_output <- readRDS(paste0(dir, 'Results/EarlyWinter2021-output-', data_run_date, '/EarlyWinter2021-output-', data_run_date, '.rds'))
earlyWinter2021_data <- readRDS(paste0(dir, 'Results/EarlyWinter2021-output-', data_run_date, '/EarlyWinter2021-data-', data_run_date, '.rds'))


#late winter 2021
lateWinter2021_output <- readRDS(paste0(dir, 'Results/LateWinter2021-output-', data_run_date, '/LateWinter2021-output-', data_run_date, '.rds'))
lateWinter2021_data <- readRDS(paste0(dir, 'Results/LateWinter2021-output-', data_run_date, '/LateWinter2021-data-', data_run_date, '.rds'))


#late winter 2022
lateWinter2022_output <- readRDS(paste0(dir, 'Results/LateWinter2022-output-', data_run_date, '/LateWinter2022-output-', data_run_date, '.rds'))
lateWinter2022_data <- readRDS(paste0(dir, 'Results/LateWinter2022-output-', data_run_date, '/LateWinter2022-data-', data_run_date, '.rds'))



#Function that calculates residuals and vulnerability and saves a data frame with all results and 
#the list of residuals

vulnerab_results <- function(model_output, model_data, season) {
  
  # Extract parameter samples
  beta0_samples <- model_output$sims.list$beta0
  beta1_samples <- model_output$sims.list$beta1
  
  # Calculate the residuals for each iteration of the samples
  residuals_list <- vector("list", length(beta0_samples))
  y_mort <- model_data$y_mort    #already log10+1
  for (i in 1:length(beta0_samples)) {
    residuals_list[[i]] <- y_mort - (beta0_samples[i] + 
                                       beta1_samples[i] * model_output$mean$N_UV_totLog)
  }
  
  
  # Combine the residuals from all iterations
  all_residuals <- do.call(cbind, residuals_list)
  rownames(all_residuals) <- dimnames(model_data$countsUV)[[3]]
  resid_mean <- apply(all_residuals, 1, mean)
  #resid_median <- apply(all_residuals, 1, median)
  #resid_sd <- apply(all_residuals, 1, sd)
  resid_CI025 <- apply(all_residuals, 1, quantile, probs=0.025)
  resid_CI975 <- apply(all_residuals, 1, quantile, probs=0.975)
  
  #10^residuals to get the risk (vulnerability) 
  #How much more vulnerable a species is relative to the average
  #MCMC_10RES <- 10^abs(all_residuals)
  
  #vul_mean <- apply(MCMC_10RES, 1, mean)
  #vul_median <- apply(MCMC_10RES, 1, median)
  #vul_sd <- apply(MCMC_10RES, 1, sd)
  #vul_CI025 <- apply(MCMC_10RES, 1, quantile, probs=0.025)
  #vul_CI975 <- apply(MCMC_10RES, 1, quantile, probs=0.975)
  
  if(season == 'fall'){
    results_df <- data.frame(cbind(SPECIES = dimnames(model_data$countsUV)[[3]],
                                   N_counted_UV = colSums(apply(model_data$countsUV, c(2,3), FUN = sum)),
                                   N_estimated_UV = round(model_output$mean$N_UV_tot, 0),
                                   N_estimated_UV_025CI = round(model_output$q2.5$N_UV_tot, 0),
                                   N_estimated_UV_975CI = round(model_output$q97.5$N_UV_tot, 0),
                                   N_counted_Band = colSums(apply(model_data$countsBand, c(2,3), FUN = sum)),
                                   N_estimated_Band = round(model_output$mean$N_band_tot, 0),
                                   N_estimated_Band_2.5CI = round(model_output$q2.5$N_band_tot, 0),
                                   N_estimated_Band_97.5CI = round(model_output$q97.5$N_band_tot, 0),
                                   N_collisions = 10^y_mort-1, #backtransform to the original values
                                   resid_mean = round(resid_mean,2),
                                   #resid_median = round(resid_median,2),
                                   #resid_sd = round(resid_sd,2),
                                   resid_025CI = round(resid_CI025,2),
                                   resid_975CI = round(resid_CI975,2)))
                                   #vulnera_mean = round(vul_mean,2),
                                   #vulnera_median = round(vul_median,2),
                                   #vulnera_sd = round(vul_sd,2),
                                   #vulnera_025CI = round(vul_CI025,2),
                                   #vulnera_975CI = round(vul_CI975,2)))
  } else{
    results_df <- data.frame(cbind(SPECIES = dimnames(model_data$countsUV)[[3]],
                                   N_counted_UV = colSums(apply(model_data$countsUV, c(2,3), FUN = sum)),
                                   N_estimated_UV = round(model_output$mean$N_UV_tot, 0),
                                   N_estimated_UV_025CI = round(model_output$q2.5$N_UV_tot, 0),
                                   N_estimated_UV_975CI = round(model_output$q97.5$N_UV_tot, 0),
                                   N_collisions = 10^y_mort-1, #backtransform to the original values
                                   resid_mean = round(resid_mean,2),
                                   #resid_median = round(resid_median,2),
                                   #resid_sd = round(resid_sd,2),
                                   resid_025CI = round(resid_CI025,2),
                                   resid_975CI = round(resid_CI975,2)))
                                   #vulnera_mean = round(vul_mean,2),
                                   #vulnera_median = round(vul_median,2),
                                   #vulnera_sd = round(vul_sd,2),
                                   #vulnera_025CI = round(vul_CI025,2),
                                   #vulnera_975CI = round(vul_CI975,2)))
  }
  
  return(list(results_df, all_residuals))
  
}


#Fall 2019
resultsFall2019 <- vulnerab_results(fall2019_output, fall2019_data, 
                                    season = 'fall')

#Fall 2020
resultsFall2020 <- vulnerab_results(fall2020_output, fall2020_data, 
                                    season = 'fall')

#Late winter 2020 (jan/feb)
resultsLateWinter2020 <- vulnerab_results(lateWinter2020_output, lateWinter2020_data, 
                                          season = 'winter')

#Early winter 2021 (nov/dec)
resultsEarlyWinter2021 <- vulnerab_results(earlyWinter2021_output, earlyWinter2021_data, 
                                          season = 'earlywinter')

#Late winter 2021 (jan/feb)
resultsLateWinter2021 <- vulnerab_results(lateWinter2021_output, lateWinter2021_data, 
                                          season = 'winter')

#Late winter 2022 (jan/feb)
resultsLateWinter2022 <- vulnerab_results(lateWinter2022_output, lateWinter2022_data, 
                                          season = 'winter')


#make tables:
fall2019 <- resultsFall2019[[1]]
fall2019$N_estimated_UV <- paste0(fall2019$N_estimated_UV, ' (', fall2019$N_estimated_UV_025CI, '-', fall2019$N_estimated_UV_975CI, ')')
fall2019$N_estimated_Band <- paste0(fall2019$N_estimated_Band, ' (', fall2019$N_estimated_Band_2.5CI, '-', fall2019$N_estimated_Band_97.5CI, ')')
fall2019$resid_mean <- paste0(fall2019$resid_mean, ' (', fall2019$resid_025CI, '-', fall2019$resid_975CI, ')')

fall2019 <- fall2019 %>%
  dplyr::select(SPECIES, N_counted_UV, N_estimated_UV, N_counted_Band, N_estimated_Band, N_collisions, resid_mean)

write.csv(fall2019, file = paste0(dir, 'Results/TableFall2019-', run_date, '.csv'))



#fall 2020
fall2020 <- resultsFall2020[[1]]
fall2020$N_estimated_UV <- paste0(fall2020$N_estimated_UV, ' (', fall2020$N_estimated_UV_025CI, '-', fall2020$N_estimated_UV_975CI, ')')
fall2020$N_estimated_Band <- paste0(fall2020$N_estimated_Band, ' (', fall2020$N_estimated_Band_2.5CI, '-', fall2020$N_estimated_Band_97.5CI, ')')
fall2020$resid_mean <- paste0(fall2020$resid_mean, ' (', fall2020$resid_025CI, '-', fall2020$resid_975CI, ')')

fall2020 <- fall2020 %>%
  dplyr::select(SPECIES, N_counted_UV, N_estimated_UV, N_counted_Band, N_estimated_Band, N_collisions, resid_mean)

write.csv(fall2020, file = paste0(dir, 'Results/TableFall2020-', run_date, '.csv'))



#late winter 2020
latewinter2020 <- resultsLateWinter2020[[1]]
latewinter2020$N_estimated_UV <- paste0(latewinter2020$N_estimated_UV, ' (', latewinter2020$N_estimated_UV_025CI, '-', latewinter2020$N_estimated_UV_975CI, ')')
latewinter2020$resid_mean <- paste0(latewinter2020$resid_mean, ' (', latewinter2020$resid_025CI, '-', latewinter2020$resid_975CI, ')')

latewinter2020 <- latewinter2020 %>%
  dplyr::select(SPECIES, N_counted_UV, N_estimated_UV, N_collisions, resid_mean)

write.csv(latewinter2020, file = paste0(dir, 'Results/TableLateWinter2020-', run_date, '.csv'))



#early winter 2021
earlywinter2021 <- resultsEarlyWinter2021[[1]]
earlywinter2021$N_estimated_UV <- paste0(earlywinter2021$N_estimated_UV, ' (', earlywinter2021$N_estimated_UV_025CI, '-', earlywinter2021$N_estimated_UV_975CI, ')')
earlywinter2021$resid_mean <- paste0(earlywinter2021$resid_mean, ' (', earlywinter2021$resid_025CI, '-', earlywinter2021$resid_975CI, ')')

earlywinter2021 <- earlywinter2021 %>%
  dplyr::select(SPECIES, N_counted_UV, N_estimated_UV, N_collisions, resid_mean)

write.csv(earlywinter2021, file = paste0(dir, 'Results/TableEarlyWinter2021-', run_date, '.csv'))



#late winter 2021
latewinter2021 <- resultsLateWinter2021[[1]]
latewinter2021$N_estimated_UV <- paste0(latewinter2021$N_estimated_UV, ' (', latewinter2021$N_estimated_UV_025CI, '-', latewinter2021$N_estimated_UV_975CI, ')')
latewinter2021$resid_mean <- paste0(latewinter2021$resid_mean, ' (', latewinter2021$resid_025CI, '-', latewinter2021$resid_975CI, ')')

latewinter2021 <- latewinter2021 %>%
  dplyr::select(SPECIES, N_counted_UV, N_estimated_UV, N_collisions, resid_mean)

write.csv(latewinter2021, file = paste0(dir, 'Results/TableLateWinter2021-', run_date, '.csv'))



#late winter 2022
latewinter2022 <- resultsLateWinter2022[[1]]
latewinter2022$N_estimated_UV <- paste0(latewinter2022$N_estimated_UV, ' (', latewinter2022$N_estimated_UV_025CI, '-', latewinter2022$N_estimated_UV_975CI, ')')
latewinter2022$resid_mean <- paste0(latewinter2022$resid_mean, ' (', latewinter2022$resid_025CI, '-', latewinter2022$resid_975CI, ')')

latewinter2022 <- latewinter2022 %>%
  dplyr::select(SPECIES, N_counted_UV, N_estimated_UV, N_collisions, resid_mean)

write.csv(latewinter2022, file = paste0(dir, 'Results/TableLateWinter2022-', run_date, '.csv'))



# write out files

saveRDS(resultsFall2019, file = paste0(dir, 'Results/Vulnerab_resultsFall2019-', run_date, '.rds'))

saveRDS(resultsFall2020, file = paste0(dir, 'Results/Vulnerab_resultsFall2020-', run_date, '.rds'))

saveRDS(resultsLateWinter2020, file = paste0(dir, 'Results/Vulnerab_resultsLateWinter2020-', run_date, '.rds'))

saveRDS(resultsEarlyWinter2021, file = paste0(dir, 'Results/Vulnerab_resultsEarlyWinter2021-', run_date, '.rds'))

saveRDS(resultsLateWinter2021, file = paste0(dir, 'Results/Vulnerab_resultsLateWinter2021-', run_date, '.rds'))

saveRDS(resultsLateWinter2022, file = paste0(dir, 'Results/Vulnerab_resultsLateWinter2022-', run_date, '.rds'))


