#######################
## Produce figures with results from abundance/vulnerability estimates

#######################


# set dirs ----------------------------------------------------------------

run_date <- Sys.Date()
data_run_date <- 'XXX'
dir <- 'XXX'


# load packages -----------------------------------------------------------

library(dplyr)
library(ggplot2)
library(gridExtra)



# read in data -----------------------------------------------------------

resultsFall2019 <- readRDS(paste0(dir, 'Results/Vulnerab_resultsFall2019-', data_run_date, '.rds'))

resultsFall2020 <- readRDS(paste0(dir, 'Results/Vulnerab_resultsFall2020-', data_run_date, '.rds'))

resultsLateWinter2020 <- readRDS(paste0(dir, 'Results/Vulnerab_resultsLateWinter2020-', data_run_date, '.rds'))

resultsEarlyWinter2021 <- readRDS(paste0(dir, 'Results/Vulnerab_resultsEarlyWinter2021-', data_run_date, '.rds'))

resultsLateWinter2021 <- readRDS(paste0(dir, 'Results/Vulnerab_resultsLateWinter2021-', data_run_date, '.rds'))

resultsLateWinter2022 <- readRDS(paste0(dir, 'Results/Vulnerab_resultsLateWinter2022-', data_run_date, '.rds'))



# join residual results from each season in a single table and extract summaries

#fall
fall <- merge(resultsFall2019[[2]], resultsFall2020[[2]], by="row.names", all=TRUE)

fallResults <- fall %>% 
  dplyr::rowwise() %>%
  dplyr::summarise(species_ID = Row.names,
                   resid_mean_fall = mean(c_across(2:8001), na.rm = TRUE),
                   resid_025CI_fall = quantile(c_across(2:8001), probs = 0.025, na.rm = TRUE),
                   resid_975CI_fall = quantile(c_across(2:8001), probs = 0.975, na.rm = TRUE)) %>%
  dplyr::ungroup()


#early winter
resultsEarlyWinter <- data.frame(resultsEarlyWinter2021[[2]]) %>%
  dplyr::mutate(Row.names = rownames(resultsEarlyWinter2021[[2]])) %>%
  dplyr::relocate(Row.names, .before = X1)

earlyWinterResults <-  resultsEarlyWinter %>%
  dplyr::rowwise() %>%
  dplyr::summarise(species_ID = Row.names,
                   resid_mean_earlyWinter = mean(c_across(2:4001), na.rm = TRUE),
                   resid_025CI_earlyWinter = quantile(c_across(2:4001), probs = 0.025, na.rm = TRUE),
                   resid_975CI_earlyWinter = quantile(c_across(2:4001), probs = 0.975, na.rm = TRUE)) %>%
  dplyr::ungroup()


#late winter
lateWinter <- merge(merge(resultsLateWinter2020[[2]], resultsLateWinter2021[[2]], by = "row.names", all = TRUE),
  resultsLateWinter2022[[2]], by.x = "Row.names", by.y = "row.names", all = TRUE)

lateWinterResults <- lateWinter %>%
  dplyr::rowwise() %>%
  dplyr::summarise(species_ID = Row.names,
                   resid_mean_lateWinter = mean(c_across(2:12001), na.rm = TRUE),
                   resid_025CI_lateWinter = quantile(c_across(2:12001), probs = 0.025, na.rm = TRUE),
                   resid_975CI_lateWinter = quantile(c_across(2:12001), probs = 0.975, na.rm = TRUE)) %>%
  dplyr::ungroup()
  


# Plot all results 

meanFall <- ggplot(data = fallResults, aes(x=reorder(species_ID, as.numeric(resid_mean_fall)), 
                                                  y=as.numeric(resid_mean_fall))) + 
  theme_minimal() +  # Change to a minimal theme
  theme(panel.grid.major = element_line(colour = "lightgrey", linewidth = 0.1),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white", color = "black", linewidth = 0.8)) +
  #scale_y_continuous(breaks = seq(-40, 120, by = 20), labels = seq(-40, 120, by = 20)) +
  geom_point(size=2) +
  geom_errorbar(aes(ymin = as.numeric(resid_025CI_fall),
                    ymax = as.numeric(resid_975CI_fall)), 
                width=0.2) +
  ggtitle("A) Fall (Sep/Oct)") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(x = "Species", y = "Residuals") +
  theme(axis.text.y = element_text(size=13),
        axis.title = element_text(size=14),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  coord_flip()



## Early Winter

meanEarlyWinter <- ggplot(data = earlyWinterResults, aes(x=reorder(species_ID, as.numeric(resid_mean_earlyWinter)), 
                                                         y=as.numeric(resid_mean_earlyWinter))) + 
  theme_minimal() +  # Change to a minimal theme
  theme(panel.grid.major = element_line(colour = "lightgrey", linewidth = 0.1),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white", color = "black", linewidth = 0.8)) +
  #scale_y_continuous(breaks = seq(-40, 120, by = 20), labels = seq(-40, 120, by = 20)) +
  geom_point(size=2) +
  geom_errorbar(aes(ymin=as.numeric(resid_025CI_earlyWinter),
                    ymax=as.numeric(resid_975CI_earlyWinter)), 
                width=0.2) +
  ggtitle("B) Early Winter (Nov/Dec)") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(x = "Species", y = "Residuals") +
  theme(axis.text.y = element_text(size=13),
        axis.title = element_text(size=14),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  coord_flip()



## Late Winter

meanLateWinter <- ggplot(data = lateWinterResults, aes(x = reorder(species_ID, as.numeric(resid_mean_lateWinter)), 
                                                       y = as.numeric(resid_mean_lateWinter))) + 
  theme_minimal() +  # Change to a minimal theme
  theme(panel.grid.major = element_line(colour = "lightgrey", linewidth = 0.1),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white", color = "black", linewidth = 0.8)) +
  #scale_y_continuous(breaks = seq(-40, 120, by = 20), labels = seq(-40, 120, by = 20)) +
  geom_point(size=2) +
  geom_errorbar(aes(ymin = as.numeric(resid_025CI_lateWinter),
                    ymax = as.numeric(resid_975CI_lateWinter)), 
                width=0.2) +
  ggtitle("C) Late Winter (Jan/Feb)") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(x = "Species", y = "Residuals") +
  theme(axis.text.y = element_text(size=13),
        axis.title = element_text(size=14),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  coord_flip()


#save
pdf(paste0(dir, 'Results/ResultsResiduals-', run_date, '.pdf'), 
    width = 12, height = 16)

grid.arrange(meanFall, meanEarlyWinter, meanLateWinter, 
             ncol=2, layout_matrix = rbind(c(1, 2), #first plot takes all first column
                                           c(1, 3)))
dev.off()




# Plot results for vulnerable species

resultsFall_filter_sp <- fallResults %>%
  dplyr::filter(resid_mean_fall > 0,
                resid_025CI_fall > 0,
                resid_975CI_fall > 0) 

resultsEarlyWinter_filter_sp <- earlyWinterResults %>%
  dplyr::filter(resid_mean_earlyWinter > 0,
                resid_025CI_earlyWinter > 0,
                resid_975CI_earlyWinter > 0)

resultsLateWinter_filter_sp <- lateWinterResults %>%
  dplyr::filter(resid_mean_lateWinter > 0,
                resid_025CI_lateWinter > 0,
                resid_975CI_lateWinter > 0)



vulnerSpecies <- unique(c(resultsFall_filter_sp$species_ID, 
                          resultsEarlyWinter_filter_sp$species_ID, 
                          resultsLateWinter_filter_sp$species_ID))


fallResults_sp <- fallResults %>%
  dplyr::filter(species_ID %in% vulnerSpecies) %>%
  dplyr::rename(resid_mean_fall = resid_mean_fall,
                resid_025CI_fall = resid_025CI_fall,
                resid_975CI_fall = resid_975CI_fall)

earlyWinterResults_sp <- earlyWinterResults %>%
  dplyr::filter(species_ID %in% vulnerSpecies) %>%
  #dplyr::mutate(season = "EarlyWinter") %>%
  dplyr::rename(resid_mean_earlyWinter = resid_mean_earlyWinter,
                resid_025CI_earlyWinter = resid_025CI_earlyWinter,
                resid_975CI_earlyWinter = resid_975CI_earlyWinter)
  
lateWinterResults_sp <- lateWinterResults %>%
  dplyr::filter(species_ID %in% vulnerSpecies) %>%
  #dplyr::mutate(season = "LateWinter") %>%
  dplyr::rename(resid_mean_lateWinter = resid_mean_lateWinter,
                resid_025CI_lateWinter = resid_025CI_lateWinter,
                resid_975CI_lateWinter = resid_975CI_lateWinter)


species_results <- data.frame(cbind(species_ID = vulnerSpecies))

species_results <- species_results %>%
  dplyr::left_join(fallResults_sp, by = 'species_ID') %>%
  dplyr::left_join(earlyWinterResults_sp, by = 'species_ID') %>%
  dplyr::left_join(lateWinterResults_sp, by = 'species_ID')


species_order <- c("HermitThrush",
                   "FoxSparrow",
                   "GoldenCrownedKinglet", 
                   "SwainsonsThrush",
                   "VariedThrush", 
                   "GoldenCrownedSparrow",
                   "OrangeCrownedWarbler",
                   "YellowRumpedWarbler",
                   "AmericanRobin",
                   "AnnasHummingbird")

species_results$species_ID <- factor(species_results$species_ID, levels = rev(species_order))



fall <- ggplot(data = species_results, aes(x = as.factor(species_ID), 
                                     y = as.numeric(resid_mean_fall))) + 
  theme_minimal() +  # Change to a minimal theme
  theme(panel.grid.major = element_line(colour = "lightgrey", linewidth = 0.1),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white", color = "black", linewidth = 0.8)) +
  #scale_y_continuous(breaks = seq(-40, 120, by = 20), labels = seq(-40, 120, by = 20)) +
  geom_point(size=2) +
  geom_errorbar(aes(ymin = as.numeric(resid_025CI_fall),
                    ymax = as.numeric(resid_975CI_fall)), 
                width=0.2) +
  ggtitle("A) Fall (Sep/Oct)") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(x = "Species", y = "Residuals") +
  theme(axis.text.y = element_text(size=10),
        axis.title = element_text(size=14),
        plot.title = element_text(hjust = 0.5, size = 14)) +
  coord_flip()


earlyWinter <- ggplot(data = species_results, aes(x = factor(species_ID), 
                                          y = as.numeric(resid_mean_earlyWinter))) + 
  theme_minimal() +  # Change to a minimal theme
  theme(panel.grid.major = element_line(colour = "lightgrey", linewidth = 0.1),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white", color = "black", linewidth = 0.8)) +
  #scale_y_continuous(breaks = seq(-40, 120, by = 20), labels = seq(-40, 120, by = 20)) +
  geom_point(size=2) +
  geom_errorbar(aes(ymin = as.numeric(resid_025CI_earlyWinter),
                    ymax = as.numeric(resid_975CI_earlyWinter)), 
                width=0.2) +
  ggtitle("B) Early Winter (Nov/Dec)") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(x = "Species", y = "Residuals") +
  theme(axis.text.y = element_text(size=10),
        axis.title = element_text(size=14),
        plot.title = element_text(hjust = 0.5, size = 14)) +
  coord_flip()


lateWinter <- ggplot(data = species_results, aes(x = factor(species_ID), 
                                                        y = as.numeric(resid_mean_lateWinter))) + 
  theme_minimal() +  # Change to a minimal theme
  theme(panel.grid.major = element_line(colour = "lightgrey", linewidth = 0.1),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white", color = "black", linewidth = 0.8)) +
  #scale_y_continuous(breaks = seq(-40, 120, by = 20), labels = seq(-40, 120, by = 20)) +
  geom_point(size=2) +
  geom_errorbar(aes(ymin = as.numeric(resid_025CI_lateWinter),
                    ymax = as.numeric(resid_975CI_lateWinter)), 
                width=0.2) +
  ggtitle("C) Late Winter (Jan/Feb)") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(x = "Species", y = "Residuals") +
  theme(axis.text.y = element_text(size=10),
        axis.title = element_text(size=14),
        plot.title = element_text(hjust = 0.5, size = 14)) +
  coord_flip()


#save
pdf(paste0(dir, 'Results/ResultsResidualsSpecies-', run_date, '.pdf'), 
    width = 14, height = 5)

gridExtra::grid.arrange(fall, earlyWinter, lateWinter, ncol=3)

dev.off()






ggplot(data = all_results, aes(x = reorder(species_ID, as.numeric(resid_mean)), 
                                                       y = as.numeric(resid_mean), color = season)) + 
  theme_minimal() +  # Change to a minimal theme
  theme(panel.grid.major = element_line(colour = "lightgrey", linewidth = 0.1),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white", color = "black", linewidth = 0.8)) +
  #scale_y_continuous(breaks = seq(-40, 120, by = 20), labels = seq(-40, 120, by = 20)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black", linewidth = 0.5) +
  geom_point(size=3, position = position_dodge(width = 0.4)) +
  geom_errorbar(aes(ymin = as.numeric(resid_025CI),
                    ymax = as.numeric(resid_975CI)), 
                width=0.3, linewidth = 1.1, position = position_dodge(width = 0.4)) +
  #ggtitle("C) Late Winter (Jan/Feb)") +
  labs(x = "Species", y = "Residuals") +
  theme(axis.text.y = element_text(size=12),
        axis.title = element_text(size=14),
        plot.title = element_text(hjust = 0.5, size = 16)) +
  scale_color_manual(values = c("Fall" = "#E69F00", 
               "EarlyWinter" = "#999999", 
               "LateWinter" = "#009E73")) +
  coord_flip()






